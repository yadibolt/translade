(()=>{"use strict";const t={modulePrefix:"<Translade>:",sessionName:"translade-settings",assetsFolder:"/modules/translade/",selectedLangIdDefault:"default",maximumHistoryLength:10,specialToken:"|TRSLD_SPT|",baseUrl:"/api/translade",translationEndpoint:"/translate",rephraseEndpoint:"/rephrase"};class e{constructor(){}throwException(e,n=null,s=null){return new Error(`${t.modulePrefix} ${e}\nErr: ${n}\nCode: ${s||"N/A"}`)}}const n=t=>document.getElementById(t)||(new e).throwException(`Element with ID "${t}" not found.`,null,null),s=(t,n=null)=>{if(null!==n){const s=n.getElementsByClassName(t);return s&&0!==s.length?s:(new e).throwException(`No elements found with class "${t}".`,null,null)}{const n=document.getElementsByClassName(t);return n&&0!==n.length?n:(new e).throwException(`No elements found with class "${t}".`,null,null)}},a=t=>document.getElementsByClassName(t)[0]||(new e).throwException(`First element with class "${t}" not found.`,null,null),l=(t,n=null)=>{if(null!==n){return n.querySelectorAll(t)[0]||(new e).throwException(`Element with selector "${t}" not found in the provided root.`,null,null)}return document.querySelectorAll(t)[0]||(new e).throwException(`Element with selector "${t}" not found.`,null,null)},i=(t,n=null)=>{if(null!==n){return n.querySelectorAll(t)||(new e).throwException(`Element with selector "${t}" not found in the provided root.`,null,null)}return document.querySelectorAll(t)||(new e).throwException(`Element with selector "${t}" not found.`,null,null)},r=(t=[],e=[],n)=>{t.forEach((t,e)=>{t.classList&&t.classList.contains(n)&&t.classList.remove(n)}),e.forEach((t,e)=>{t.classList&&!t.classList.contains(n)&&t.classList.add(n)})};class o{constructor(){}initConfiguration(){const t=n("translade-shadow-root-config"),s=String(t.value);if(s.length<=0)return(new e).throwException("Configuration is empty.",null,null);try{const n=JSON.parse(s.trim());return"object"!=typeof n?(new e).throwException("Parsed configuration is not an object.",null,null):(t.remove(),{languages:String(n.languages).trim().split(","),contentLanguage:String(n.content_language).trim(),formId:String(n.form_id),history:{}})}catch(t){return(new e).throwException("Tried to parse invalid JSON configuration.",t,null)}}}const c={selectedLangId:t.selectedLangIdDefault};class d{sessionIdentifier=null;constructor(){this.sessionIdentifier=t.sessionName}initSession(){return window.sessionStorage.getItem(this.sessionIdentifier)||(window.sessionStorage.setItem(this.sessionIdentifier,JSON.stringify(this._getSessionSettingsDefault())),window.sessionStorage.getItem(this.sessionIdentifier))}getSession(){const t=window.sessionStorage.getItem(this.sessionIdentifier);if(!t)return this.initSession();try{return JSON.parse(t)}catch(t){return(new e).throwException("Tried to parse invalid JSON.",t,null)}}updateData(n){if(!this.getSession())return(new e).throwException("Session does not exits",null,null);if("object"!=typeof n)return(new e).throwException("Passed data must be an object.",null,null);try{let e=this.getSession(),s=JSON.stringify({...e,...n});window.sessionStorage.setItem(t.sessionName,s)}catch(t){return(new e).throwException("Tried to update session with invalid data.",t,null)}}clearSession(){this.updateData({})}destroySession(){window.sessionStorage.removeItem(this.sessionIdentifier)}_getSessionSettingsDefault(){return c}}class u{id=null;classNames=null;dataset={};content=null;constructor(...t){const{id:e=null,dataset:n={},classNames:s=null,content:a=null}=t[0]||{};this.id=e,this.classNames=s,this.content=a,this.dataset=n}getDefault(){let t=document.createElement("div");if(this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.content&&(t.innerHTML=this.content),this.dataset)for(const[e,n]of Object.entries(this.dataset))t.dataset[e]=n;return t}}class h{id=null;classNames=null;level=null;content=null;constructor(...t){const{id:e=null,classNames:n=null,level:s=1,content:a=null}=t[0]||{};this.id=e,this.classNames=n,this.level=s,this.content=a}getDefault(){let t=document.createElement(`h${this.level}`);return this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.content&&(t.innerHTML=this.content),t}}class g{id=null;classNames=null;content=null;constructor(...t){const{id:e=null,classNames:n=null,content:s=null}=t[0]||{};this.id=e,this.classNames=n,this.content=s}getDefault(){let t=document.createElement("p");return this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.content&&(t.innerHTML=this.content),t}}class m{constructor(){}getShadowRootFields(){const t=document.querySelectorAll('div[id*="translade-shadow-root-"]');return!t||t.length<=0?(new e).throwException("Could not find fields.",null,null):t}}class f{id=null;classNames=null;src=null;alt=null;constructor(...t){const{id:e=null,classNames:n=null,src:s=null,alt:a=null}=t[0]||{};this.id=e,this.classNames=n,this.src=s,this.alt=a}getDefault(){let t=document.createElement("img");return this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.src&&(t.src=this.src),this.alt&&(t.alt=this.alt),t}}class p{id=null;classNames=null;content=null;constructor(...t){const{id:e=null,classNames:n=null,content:s=null}=t[0]||{};this.id=e,this.classNames=n,this.content=s}getDefault(){let t=document.createElement("span");return this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.content&&(t.innerHTML=this.content),t}}class w{id=null;classNames=null;href=null;title=null;dataset=null;content=null;constructor(...t){const{id:e=null,classNames:n=null,href:s=null,title:a=null,dataset:l=null,content:i=null}=t[0]||{};this.id=e,this.classNames=n,this.href=s,this.title=a,this.dataset=l,this.content=i}getDefault(){let t=document.createElement("a");if(this.id&&(t.id=this.id),this.classNames&&t.classList.add(...this.classNames),this.href&&(t.href=this.href),this.title&&(t.title=this.title),this.dataset)for(const[e,n]of Object.entries(this.dataset))t.dataset[e]=n;return this.content&&(t.innerHTML=this.content),t}}class S{name=null;value=null;isSelected=!1;constructor(...t){const{name:e=null,value:n=null,isSelected:s=!1}=t[0]||{};this.name=e,this.value=n,this.isSelected=s}getDefault(){const t=document.createElement("option");return this.value&&t.setAttribute("value",this.value),this.name&&(t.innerHTML=this.name),this.isSelected&&t.setAttribute("selected","selected"),t}}class v{id=null;classNames=[];name=null;options=[];constructor(...t){const{id:e=null,classNames:n=[],name:s=null,options:a=[]}=t[0]||{};this.id=e,this.classNames=n,this.name=s,this.options=a}getDefault(){const t=document.createElement("select");return this.id&&(t.id=this.id),this.classNames.length>0&&t.classList.add(...this.classNames),this.name&&(t.name=this.name),this.options.length>0&&this.options.forEach(n=>{if(!n)return(new e).throwException("Invalid OptionTag element provided.",null,null);t.appendChild(n)}),t}}class L{constructor(){}createActionsForField(e){let n=[];window.transladeConfig.languages.forEach((t,e)=>{const s=t.split("|"),a=s[0]===(new d).getSession().selectedLangId;window.transladeConfig.contentLanguage!==s[0]&&n.push(new S({name:s[1],value:s[0],isSelected:a}).getDefault())});const s=new u({classNames:["translade-actions-wrapper"]}).getDefault(),a=new v({classNames:["translade-languageTo"],name:"translade-languageTo",options:n}).getDefault(),l=new f({src:`${t.assetsFolder}/icons/back.svg`,alt:"Back"}).getDefault(),i=new f({src:`${t.assetsFolder}/icons/translate.svg`,alt:"Translate"}).getDefault(),r=new f({src:`${t.assetsFolder}/icons/rephrase.svg`,alt:"Rephrase"}).getDefault(),o=new p({classNames:["loader"]}).getDefault(),c=new u({classNames:["translade-action-trigger","language-select"],dataset:{targetField:e}}).getDefault();c.appendChild(a);const h=new w({classNames:["translade-action-trigger","back"],title:"Back to previous text",dataset:{targetField:e}}).getDefault();h.appendChild(l);const g=new w({classNames:["translade-action-trigger","translate"],title:"Translate text",dataset:{targetField:e}}).getDefault();g.appendChild(i);const m=new w({classNames:["translade-action-trigger","rephrase"],title:"Rephrase text",dataset:{targetField:e}}).getDefault();m.appendChild(r);const L=new w({classNames:["translade-action-trigger","load","action-hide"],title:"Loading",dataset:{targetField:e}}).getDefault();return L.appendChild(o),[h,g,c,m,L].forEach((t,e)=>{s.appendChild(t)}),s}}class y{constructor(){}getStringTypeValue=t=>{const e=l("input",t);return String(e.value)};getStringLongTypeValue=t=>{const e=l("textarea",t);return String(e.value)};getTextWithSummaryValue=e=>{let n=i(".form-textarea-wrapper",e),s=null,a=null;if(1===n.length?a=n[0]:(s=n[0],a=n[1]),i("div.ck",a).length>0){const e=l(".ck .ck.ck-content",a);return(null!==s?l("textarea",s):"").value+`${t.specialToken}`+e.innerHTML}{const e=l("textarea",a);return(null!==s?l("textarea",s):"").value+`${t.specialToken}`+e.value}};getTextLongValue=t=>{let e=s(".form-textarea-wrapper",t)[0];return i("div.ck",e).length>0?l(".ck .ck.ck-content",e).innerHTML:l("textarea",e).value};setStringTypeValue=(t,e)=>{l("input",t).value=String(e)};setStringLongTypeValue=(t,e)=>{l("textarea",t).value=String(e)};setTextWithSummaryValue=(e,n)=>{let s=i(".form-textarea-wrapper",e),a=null,r=null;if(1===s.length?a=s[0]:(r=s[0],a=s[1]),i("div.ck",a).length>0){const e=r?l("textarea",r):"";let i=n.split(`${t.specialToken}`);const o=l(".ck-editor__editable",a).ckeditorInstance;1===s.length||(e.value=String(i[0])),o&&o.setData(String(i[1]))}else{const e=l("textarea",a),s=r?l("textarea",r):null;let i=n.split(`${t.specialToken}`);null===s||(s.value=String(i[0])),e.value=String(i[1])}};setTextLongValue=(t,e)=>{let n=s(".form-textarea-wrapper",t)[0];if(i("div.ck",n).length>0){const t=l(".ck-editor__editable",n).ckeditorInstance;t&&t.setData(String(e))}else l("textarea",n).value=String(e)};setFieldData=(t,e)=>{const n=a(t),s=Array.from(n.classList).find(t=>t.startsWith("translade-type-"));if(s)switch(String(s).replaceAll("translade-type-","")){case"string":case"text":this.setStringTypeValue(n,e);break;case"string_long":this.setStringLongTypeValue(n,e);break;case"text_long":this.setTextLongValue(n,e);break;case"text_with_summary":this.setTextWithSummaryValue(n,e)}}}class N{constructor(){}setHistoryData=e=>{const n=new y;let s=window.transladeConfig.history;const l=a(e);if(!l)return;const i=Array.from(l.classList).find(t=>t.startsWith("translade-type-"));if(!i)return;let r="";switch(String(i).replaceAll("translade-type-","")){case"string":case"text":r=n.getStringTypeValue(l);break;case"string_long":r=n.getStringLongTypeValue(l);break;case"text_long":r=n.getTextLongValue(l);break;case"text_with_summary":r=n.getTextWithSummaryValue(l)}s[e]&&void 0!==s[e]?(s[e.toString()].length>=t.maximumHistoryLength&&s[e.toString()].shift(),s[e.toString()].push(r)):s[e.toString()]=[r],window.transladeConfig.history=s};getLastHistoryRecord=t=>{let e=window.transladeConfig.history;return e&&e[t]&&void 0!==e[t]?e[t][e[t].length-1]:null};restoreFromHistory=t=>{const e=new y;let n=window.transladeConfig.history;n&&n[t]&&void 0!==n[t]&&(n[t].length>1&&n[t].pop(),n[t][n[t].length-1]&&(window.transladeConfig.history=n,e.setFieldData(t,n[t][n[t].length-1])))}}class x{constructor(){}renderTopBar(){const t=n("translade-mount-shadow-root"),e=new u({classNames:["translade-wrapper"]}).getDefault();[new h({level:3,content:"Translade"}).getDefault(),new g({content:"Select a language to translate to."}).getDefault()].forEach((t,n)=>{e.appendChild(t)}),t.appendChild(e)}renderActionsForFields(){let t=new L,e=new N;(new m).getShadowRootFields().forEach((n,s)=>{const a=n.id.replaceAll("translade-shadow-root-","translade-field-"),l=t.createActionsForField(a);n.appendChild(l),e.setHistoryData(a)})}}class E{constructor(){}translate(e,n){const s=window.transladeConfig,a=new y,i=new N,o=(new d).getSession(),c=i.getLastHistoryRecord(e);let u=l("a.back",n),h=l("a.translate",n),g=l("a.rephrase",n),m=l("a.load",n),f=l("div.language-select",n);const p={form_id:String(s.formId),text:String(c),trigger_id:String(e),source_lang:String(s.contentLanguage),target_lang:String(o.selectedLangId)};return r([m],[u,h,g,f],"action-hide"),new Promise((n,s)=>{fetch(`${t.baseUrl}${t.translationEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(p)}).then(t=>t.json()).then(t=>{t.form_id&&t.source_lang&&t.target_lang&&t.status&&t.translated_text&&t.trigger_id||(r([u,h,g,f],[m],"action-hide"),s("Returned data do not follow the structure.")),a.setFieldData(t.trigger_id,t.translated_text),i.setHistoryData(e),r([u,h,g,f],[m],"action-hide"),n(t)}).catch(t=>{r([u,h,g,f],[m],"action-hide"),s(t)})})}rephrase(e,n){const s=window.transladeConfig,a=new y,i=new N,o=i.getLastHistoryRecord(e);let c=l("a.back",n),d=l("a.translate",n),u=l("a.rephrase",n),h=l("a.load",n),g=l("div.language-select",n);const m={form_id:String(s.formId),text:String(o),trigger_id:String(e),source_lang:String(s.contentLanguage)};return r([h],[c,d,u,g],"action-hide"),new Promise((n,s)=>{fetch(`${t.baseUrl}${t.rephraseEndpoint}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(m)}).then(t=>t.json()).then(t=>{t.form_id&&t.source_lang&&t.status&&t.rephrased_text&&t.trigger_id||(r([h],[c,d,u,g],"action-hide"),s("Returned data do not follow the structure.")),a.setFieldData(t.trigger_id,t.rephrased_text),i.setHistoryData(e),r([c,d,u,g],[h],"action-hide"),n(t)}).catch(t=>{r([c,d,u,g],[h],"action-hide"),s(t)})})}}class D{constructor(){}addEventListeners(){this._evLisBackAction(),this._evLisTranslateAction(),this._evLisRephraseAction(),this._evListLanguageChange()}_evLisBackAction(){(new m).getShadowRootFields().forEach((t,e)=>{const n=l("a.back",t);if(!n)return;const s=t.id.replaceAll("translade-shadow-root-","translade-field-");n.addEventListener("click",t=>{t.preventDefault(),(new N).restoreFromHistory(s)})})}_evLisTranslateAction(){(new m).getShadowRootFields().forEach((t,e)=>{const n=l("a.translate",t);if(!n)return;const s=t.id.replaceAll("translade-shadow-root-","translade-field-");n.addEventListener("click",e=>(e.preventDefault(),(new E).translate(s,t)))})}_evLisRephraseAction(){(new m).getShadowRootFields().forEach((t,e)=>{const n=l("a.rephrase",t);if(!n)return;const s=t.id.replaceAll("translade-shadow-root-","translade-field-");n.addEventListener("click",e=>(e.preventDefault(),(new E).rephrase(s,t)))})}_evListLanguageChange(){(new m).getShadowRootFields().forEach((e,n)=>{const a=l("div.language-select select",e);if(!a)return;const i=new d;i.getSession().selectedLangId.toString()===t.selectedLangIdDefault.toString()&&i.updateData({selectedLangId:selectLang.value.toString()}),a.addEventListener("change",t=>{t.preventDefault(),i.updateData({selectedLangId:t.target.value.toString()});const e=s("translade-languageTo",document);for(const n of e)n.value=t.target.value.toString()})})}}!function(t,e){t.behaviors.translade={attach:function(t,s){e("translade","body",t).forEach(function(){"loading"===document.readyState?document.addEventListener("DOMContentLoaded",n):n()})}};const n=()=>{let t=new x;window.transladeConfig=(new o).initConfiguration(),(new d).initSession(),t.renderTopBar(),t.renderActionsForFields(),(new D).addEventListeners()}}(Drupal,once)})();